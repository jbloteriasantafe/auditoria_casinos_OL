<!DOCTYPE html>

<html>
  <style>
  </style>
  <head>
    <meta charset="utf-8">
    <title></title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div>
      <h3>Beneficio BPLAY</h3>
    </div>
    <div>
      ResumenDeNegocio.csv
      <input type="file" accept=".csv" id="beneficio">
    </div>
    <div>
      OperacionesMes.csv
      <input type="file" accept=".csv" id="operaciones">
    </div>
    <div>
      <button id="generar">Generar!</button>
    </div>
    <div>
      <textarea id="resultado" readonly style="width: 100%;height: 400px;"></textarea>
    </div>
    <div>
      <a id="resultado_link">Descargar</a>
    </div>
  </body>
  <script src="/js/CSV_parser.js"></script>
  <script src="/js/jquery.js"></script>
  <script>
    function toIso(f){
      f = f.split("/");
      const lPad = function(s){return s.length == 1? '0'+s : s};
      return f[2]+'-'+lPad(f[1])+'-'+lPad(f[0]);
    }
    function getFloat(str_f){
      return parseFloat(str_f.replaceAll(" ","").replaceAll(".","").replaceAll(",","."))
    }
    function convertirBeneficio(beneficio,operaciones){
      beneficio = CSV_parse(beneficio);
      const op_fecha_idx = 4;//Hardcodeo porque los archivos son gigantes y no puedo hacerlo dinamico y rapido..
      const op_premioOapuesta_idx = 6;
      const op_bonoOefec_idx = 7;
      const op_cantidad_idx = 8;
      operaciones = CSV_parse(operaciones,{},function(value, row, col){
        if (col != op_fecha_idx && 
            col != op_premioOapuesta_idx &&
            col != op_bonoOefec_idx &&
            col != op_cantidad_idx) return "";
        return value;
      });
      let fecha_PremiosBono = {};
      {
        for(let i = 1;i<operaciones.length;i++){
          const row = operaciones[i];
          const premioOapuesta  = row[op_premioOapuesta_idx-1];
          const bonoOefect = row[op_bonoOefec_idx-1];
          if(premioOapuesta != "Premio" || bonoOefect != "Bono universal") continue;
          const fecha = row[op_fecha_idx-1];
          const nfecha = fecha.split(" ")[0];
          const cantidad = row[op_cantidad_idx-1];
          if(!(nfecha in fecha_PremiosBono)) fecha_PremiosBono[nfecha] = 0.0;
          const ncantidad = getFloat(cantidad);
          fecha_PremiosBono[nfecha]+=ncantidad;
          aux += fecha + " --- " + ncantidad + "\n";
        }
      }
      let resultado = [];
      {
        let header = beneficio[0];
        const DateReport_idx = header.indexOf("Periodo");
        const Players_idx = header.indexOf("Jugadores");
        const TotalDeposits_idx = header.indexOf("Ventas Brutas");
        const TotalWithdrawals_idx = header.indexOf("Retiradas");
        const TotalManualAdjustments_idx = header.indexOf("Ajuste Manual");
        const TotalWager_idx = header.indexOf("Apuestas Totales");
        const PremiosEfectivo_idx = header.indexOf("Premios Efectivo");
        resultado.push([
            "Total",
            "DateReport",
            "Currency",
            "TotalRegistrations",
            "Verified",
            "TotalVerified",
            "Players",
            "TotalDeposits",
            "TotalWithdrawals",
            "TotalBonus",
            "TotalManualAdjustments",
            "TotalVPoints",
            "TotalWager",
            "TotalOut",
            "GrossRevenue",
            "lastupdated",
        ]);
        for(let i = 1;i<beneficio.length;i++){
          const row = beneficio[i];
          const fecha = row[DateReport_idx];
          const premio_bono = fecha in fecha_PremiosBono? fecha_PremiosBono[fecha] : 0.00;
          //Premios = Premios_Ef + PremiosBono
          const premio_total = Math.abs(getFloat(row[PremiosEfectivo_idx])) + Math.abs(premio_bono);
          //Beneficios = Apuestas - Premios
          const beneficio_total = getFloat(row[TotalWager_idx])-premio_total;
          resultado.push([
            "",
            row[DateReport_idx] + " 06:00:00",
            "ARS",
            "",
            "",
            "",
            row[Players_idx],
            row[TotalDeposits_idx],
            row[TotalWithdrawals_idx],
            "",
            row[TotalManualAdjustments_idx],
            "",
            row[TotalWager_idx],
            premio_total.toFixed(2).replaceAll(".",","),
            beneficio_total.toFixed(2).replaceAll(".",","),
            "",
          ]);
        }
      }
      const resultado_str = CSV_stringify(resultado).replaceAll('\n','\r\n'); 
      $('#resultado').val(resultado_str);
      let blob = new Blob([resultado_str],{type: 'text/csv'});
      const link = window.URL.createObjectURL(blob);
      $('#resultado_link').attr('href',link);
      const desde = toIso(resultado[1][1].split(" ")[0]);
      const hasta = toIso(resultado[resultado.length-1][1].split(" ")[0]);
      $('#resultado_link').attr('download',`beneficio_BP_${desde}_${hasta}.csv`);
    }
    $('#generar').click(function(e){
      e.preventDefault();
      let beneficio_reader = new FileReader();
      beneficio_reader.onload = function(){
        let operaciones_reader = new FileReader();
        operaciones_reader.onload = function(){
          convertirBeneficio(beneficio_reader.result,operaciones_reader.result);    
        };
        operaciones_reader.readAsText($('#operaciones')[0].files[0]);   
      };
      beneficio_reader.readAsText($('#beneficio')[0].files[0]);
    });
  </script>
</html>
